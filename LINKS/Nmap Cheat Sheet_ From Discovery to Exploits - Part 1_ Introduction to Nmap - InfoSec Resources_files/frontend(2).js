jQuery( window ).on( "init.icegram" , function() {
	if(typeof(Icegram_Message_Type) !== 'undefined'){
		Icegram_Message_Type.prototype.on_cta_click = function ( e ) {
			e.data = e.data || { self: this };
			e.data.self.track( 'clicked' );
			//if form is present then forcefully submit it
			if(jQuery(e.target).closest('.icegram').find('form').length ){
				var form = jQuery(e.target).closest('.icegram').find('form:visible').first();
				if(jQuery(form).find('.ig_form_required_field').length && jQuery(form).find('.ig_form_required_field').val() !== ''){
			    	e.preventDefault();
			    	e.data.self.hide();
			    	return;
			    }
				e.data.self.data.cta = (e.data.self.data.cta !== 'form_via_ajax') ? 'form' : e.data.self.data.cta ;
			}

			// CTA - Form submission
			if((e.data.self.data.cta === 'form' || e.data.self.data.cta === 'form_via_ajax') && typeof(form) !== 'undefined' &&  jQuery(form).find('.ig_form_required_field').val() === ''){
				if(e.data.self.data.cta === 'form'){
					if(e.data.self.data.cta_option_form_new_window === 'yes'){
						jQuery(form).attr('target' ,'_blank');
				    }
					jQuery(form).submit();
					// CTA - Form submission via Ajax
				}else if(e.data.self.data.cta === 'form_via_ajax'){
					e.preventDefault();
					show_loader();
					var action = jQuery(form).attr('action'); 
					// Check if this is a cross domain request, if so, use our proxy
					if (action.indexOf(window.location.host) === -1) {
						if (!/^https?:\/\//i.test(action)) {
							if(!/^\/\//i.test(action)){
					    		action = "http://" + action;
							}else{
					    		action = "http:" + action;
							}
					    }
						action = window.icegram.data.ajax_url + '?action=ig_cta_actions_proxy&ig_orig_action=' + encodeURIComponent(action);
					}
					var data = jQuery(form).serialize();
					data +='&cta_proxy_nonce='+window.icegram.data.cta_proxy_nonce;
					var ajax_option = e.data.self.data.cta_option_form_via_ajax;
					jQuery.ajax({
						url: action,
						data: data,
						type: 'POST',
						dataType: 'html',
						success: function(response){
							console.log(response,'res');
							jQuery('.ig_cta_overlay').hide();
							if(ajax_option == 'hide_on_success'){
								e.data.self.hide();
							}else if(ajax_option == 'show_response'){
								jQuery(e.target).closest('.icegram').find('.ig_message').html(response);
							}else if(ajax_option == 'redirect_to_link'){
								if (typeof(e.data.self.data.redirect_to_link) === 'string' && e.data.self.data.redirect_to_link != '' && !/^tel:/i.test(e.data.self.data.redirect_to_link)) {
								    if (!/^https?:\/\//i.test(e.data.self.data.redirect_to_link) ) {
								    	e.data.self.data.redirect_to_link = "http://" + e.data.self.data.redirect_to_link;
								    }
							    }
								(e.data.self.data.redirect_to_link != '') ? window.location.href = e.data.self.data.redirect_to_link : e.data.self.hide();
							}
						},
						error: function(response){
							jQuery('.ig_cta_overlay').hide();
							jQuery(e.target).closest('.icegram').find('.ig_message').append(response);
						},
					});

				}
	        }else if(e.data.self.data.cta === 'cta_another_message'){ // CTA - Open another message
	        	setTimeout(function(){
			   		icegram.get_message_by_id(e.data.self.data.cta_linked_message_id).show();
	        	},10);
	        }else if(e.data.self.data.cta === 'url'&& e.data.self.data.link != ''){ // CTA - go to link
				    (e.data.self.data.cta_option_new_window === 'yes' ) ? window.open(e.data.self.data.link):window.location.href = e.data.self.data.link ;
	        }else if(e.data.self.data.hide !== false){ // CTA - Hide this message
	        	e.data.self.hide();
	        }
	        function show_loader(){
	        	var imagepath =  jQuery('script[src*="/ig-cta-actions/classes/../assets/js/frontend.js"]').attr('src').replace('assets/js/frontend.js' ,'images/spinner-2x.gif');
				jQuery('body').append('<div class="ig_cta_overlay"></div>');
				jQuery('.ig_cta_overlay').css({'width': '100%',
					'height': '100%',
					'top': '0',
					'left': '0',
					'background': '#E6E6E6',
					'z-index': '1000000',
					'position': 'fixed',
					'opacity': '0.5',
					});
				jQuery('.ig_cta_overlay').append('<div class="cta_spinner"></div>');
				jQuery('.cta_spinner').css({
					'background' : 'url('+imagepath+') no-repeat no-repeat center',
					'height': '100%'
				});
	        	
	        }
		};
	}
});